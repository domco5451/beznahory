---
import StarRating from "../components/ratings/StarRating.astro";
import PageLayout from "./PageLayout.astro";
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";

const { frontmatter, headings, remarkPluginFrontmatter } = Astro.props;
---
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/2.1.2/gpx.min.js" defer></script>
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />


<PageLayout title={frontmatter.title}>
  <div class="markdown-post-layout">
    <div class="aside-container-left">
      <aside>
        <div id="gpx-info"></div>
      {frontmatter.gpx ? (
            <div id="map"></div>
            <a href={frontmatter.gpx} class="gpx-link">
              <Icon name="download" size={20} />
              Stiahnuť trasu (.gpx)
            </a>
          ) : null}
          {frontmatter.latitude && frontmatter.longitude ? (
            <a class="map-link" href={`/map#${Astro.url.pathname.split('/').filter(Boolean).pop()}`}>
              <Icon name="gps" size={20}/>
              <p>
                Zobraziť na mape
              </p>
            </a>
          ) : null}
         <!--  <section class="ratings">
            <div class="rating-container">
              <span class="difficulty">Obtiažnosť: </span>
              <StarRating score={frontmatter.ratings.difficulty} size={20} />
            </div>
            <div class="rating-container">
              <span class="difficulty">Výhľady: </span>
              <StarRating score={frontmatter.ratings.views} size={20} />
            </div>
            <div class="rating-container">
              <span class="difficulty">Terén: </span>
              <span>{frontmatter.ratings.terrain}</span>
            </div>
            <div class="rating-container">
              <span class="difficulty">Dĺžka: </span>
              <span>{frontmatter.ratings.length}</span>
            </div>
            <div class="rating-container">
              <span class="difficulty">Čas: </span>
              <span>{frontmatter.ratings.time}</span>
            </div>
          </section> -->
      </aside>
    </div>
    <article>
      <Image
        class="thumbnail"
        src={frontmatter.thumbnail}
        alt={frontmatter.thumbnailAlt}
        inferSize={true}
        layout="constrained"
        loading="eager"
      />
      <h1>{frontmatter.title}</h1>
      <header>
        <div class="author-info">
          <Image
            class="pfp"
            src={frontmatter.pfp}
            alt={frontmatter.pfpAlt}
            inferSize={true}
            layout="constrained"
            loading="eager"
          />
          <p><strong>{frontmatter.author}</strong></p>
        </div>
        <div class="flex-container">
          <Icon name="date" size={20}/>
          <p>{frontmatter.pubDate.toLocaleDateString()}</p>
        </div>
        <div class="flex-container">
          <Icon name="read" size={20}/>
          <p>{remarkPluginFrontmatter.minutesRead}</p>
        </div>
      </header>
      <section class="markdown-content">
        <slot />
      </section>
    </article>
    <div class="aside-container">
      <aside class="markdown-heading">
           <h2 class="page-title">Obsah článku</h2>
            {headings.map((heading: any) => (
              <a href={`#${heading.slug}`} class="page-description-container">
                <p class="page-description">
                  {heading.text}
                </p>
              </a>
            ))}
        </aside>
    </div>
  </div>
  <div class="map-modal-overlay" id="mapModal">
    <div class="map-modal-container">
      <div class="map-modal-close" id="closeMapModal" aria-label="Zavrieť mapu">&times;</div>
      <div id="modal-map"></div>
  </div>
</div>
</PageLayout>

<style>
  html {
    scroll-behavior: smooth; 
  }
  article {
    flex: 1;
  }
  header {
    display: flex;
    align-items: center;
    gap: 40px;
    margin-bottom: 20px;
  }
  h1 {
    font-size: 2.3rem;
    font-weight: bold;
    margin-block: 20px;
    color: var(--nav-hover-text);
  }
  .markdown-post-layout {
    max-width: 1500px;
    margin: 50px auto;
    display: flex;
    gap: 60px;
    position: relative;
    padding: 0 20px;
  }

  /* Markdown */

  :global(.markdown-content p) {
    line-height: 2;
    margin-block: 20px;
  }
  :global(.markdown-content h2) {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--nav-hover-text);
    margin-block: 20px;
    scroll-margin-top: 80px;
  }
  .author-info {
    display: flex;
    align-items: center;
    gap: 20px;
  }
  .pfp {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 100%;
  }
  .thumbnail {
    max-width: 100%;
    height: 400px;
    object-fit: cover;
    border-radius: 10px;
  }
  .flex-container {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* TOC */

  .aside-container {
    position: sticky;
    top: 100px;
    width: 200px;
    height: fit-content;
    align-items: start;
    flex-shrink: 0;
  }
  .markdown-heading .page-title {
    font-size: 1.3rem;
    color: var(--nav-hover-text);
    margin-bottom: 10px;
    letter-spacing: 2px;
  }
  .markdown-heading .page-description {
    font-size: 0.85rem;
    color: var(--text-primary);
    padding-inline-end: 20px;
    padding-inline-start: 10px;
  }
  .page-description-container {
    height: 60px;
    width: fit-content;
    display: flex;
    align-items: center;
    gap: 15px;
    border-radius: 0px 5px 5px 0px;
    border-inline-start: 4px solid var(--toc-border);
  }
  .page-description-container:hover .page-description {
    color: var(--nav-hover-text);
  }
  .page-description-container.active {
    background: var(--nav-hover-bg);
    border-inline-start: 4px solid var(--nav-hover-text);
  }
  
  /* Map link styling */
  
  .map-link {
    color: var(--nav-hover-text);
    background-color: var(--nav-hover-bg);
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 10px;
    border-radius: 5px;
  }
  .map-link:hover {
    text-decoration: underline;
  }
  
  /* Ratings */

  .ratings {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
  }
  .rating-container {
    display: flex;
    align-items: center;
  }
  .ratings .difficulty {
    color: var(--nav-hover-text);
    font-weight: bold;
    margin-right: 10px;
  }
  /* Gpx */
  .aside-container-left {
    position: sticky;
    top: 100px;
    width: 200px;
    height: fit-content;
    flex-shrink: 0;
  }
  .gpx-link {
    color: var(--nav-hover-text);
    background-color: var(--nav-hover-bg);
    display: flex;
    align-items: center;
    margin-block-end: 20px;
    gap: 5px;
    padding: 10px;
    border-radius: 5px;
  }
  #map {
    width: 200px;
    height: 200px;
    border-radius: 10px;
    margin-block-end: 20px;
    z-index: 1;
  }
  #gpx-info {
    margin-block-end: 20px;
  }
   /* Modal Window */

  .map-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  
  .map-modal-container {
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    width: 80%;
    height: 80%;
    max-width: 1000px;
    position: relative;
  }
  
  .map-modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 24px;
    background: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1010;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  
  #modal-map {
    width: 100%;
    height: 100%;
    border-radius: 5px;
  }

  /* Accessibility */

/* Carousel */
</style>
<script 
  define:vars={{ 
    hasGpx: !!frontmatter.gpx, 
    lat: frontmatter.latitude, 
    lng: frontmatter.longitude, 
    gpxPath: frontmatter.gpx 
  }}
>

document.addEventListener("DOMContentLoaded", () => {
  const mapElement = document.getElementById('map');
    if (!mapElement || !hasGpx) {
      return; // Ukonči, ak element neexistuje
    }

    if (!window.L) {
      console.error('Leaflet nie je načítaný!');
      return;
    }

    const initialLat = lat || 49.1;  // Default Slovensko 
    const initialLng = lng || 19.5;

    // Inicializácia malej mapy
    const map = L.map("map", {}).setView([initialLat, initialLng], 12); 

    // Vytvor vlastné tlačidlo pre zobrazenie v modali namiesto fullscreen
  const modalButton = L.Control.extend({
    options: {
      position: 'topright'
    },
    onAdd: function(map) {
      const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
      container.innerHTML = `<a href="#" title="Zobraziť väčšiu mapu" style="display:flex; align-items:center; justify-content:center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
          <path d="M15 3h6v6h-2V5h-4V3M3 3h6v2H5v4H3V3m6 18H3v-6h2v4h4v2m10-2v-4h2v6h-6v-2h4z"/>
        </svg>
      </a>`;
      
      container.onclick = function(e) {
        e.preventDefault();
        openMapModal(gpxPath, initialLat, initialLng);
      };
      
      return container;
    }
  });

  map.addControl(new modalButton());


    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    if (gpxPath && window.L.GPX) {
      try {
        new L.GPX(gpxPath, {
          async: true,
          polyline_options: {
            color: '#3388ff',
            weight: 2,
            opacity: 0.7
          }
        }).on('loaded', function(e) {
          map.fitBounds(e.target.getBounds());

      const distance = (e.target.get_distance() / 1000).toFixed(2); // km
      
      // Vypočítaj tempo v ms/km
      const paceMs = e.target.get_moving_pace();
      const totalSeconds = Math.floor(paceMs / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const paceFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}/km`;

      const elevationGain = Math.round(e.target.get_elevation_gain());
      const elevationMin = Math.round(e.target.get_elevation_min());
      const elevationMax = Math.round(e.target.get_elevation_max());
      const time = e.target.get_total_time();
      const duration = e.target.get_duration_string_iso(time);

      // Vlož info do DOMu pod mapu
      let infoDiv = document.getElementById('gpx-info');
      infoDiv.innerHTML = `
        <div style="
          background-color: var(--nav-hover-bg);
          border-radius: 15px;
          margin-bottom: 20px;
          position: sticky;
          top: 0px;
        ">
          <div style="
            color: var(--nav-hover-bg);
            background-color: var(--nav-hover-text);
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px;
            border-radius: 15px 15px 0 0;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
              <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9s-9-1.8-9-9s1.8-9 9-9m0 5v4m0 4h.01"/>
            </svg>
            <h3 style="font-weight: bold">
              Informácie o trase
            </h3>
          </div>
          <div style="
            padding: 15px;
          ">
            <p style="margin-bottom: 5px; color: var(--nav-hover-text)"><strong>Tempo</strong>: ${paceFormatted}</p>
            <p style="margin-bottom: 5px; color: var(--nav-hover-text)"><strong>Dĺžka</strong>: ${distance} km</p>
            <p style="margin-bottom: 5px; color: var(--nav-hover-text)"><strong>Prevýšenie</strong>: ${elevationGain} m</p>
            <p style="margin-bottom: 5px; color: var(--nav-hover-text)"><strong>Najnižší bod</strong>: ${elevationMin} m</p>
            <p style="margin-bottom: 5px; color: var(--nav-hover-text)"><strong>Najvyšší bod</strong>: ${elevationMax} m</p>
            <p style="margin-bottom: 5px; color: var(--nav-hover-text)"><strong>Trvanie</strong>: ${duration}</p>
          </div>
        </div>
      `;
        }).addTo(map);
      } catch (e) {
        console.error('Chyba pri načítaní GPX', e);
      }
    }
})

function openMapModal(gpxPath, lat, lng) {
    const modalOverlay = document.getElementById('mapModal');
    const modalMapContainer = document.getElementById('modal-map');
    const closeButton = document.getElementById('closeMapModal');
    
    // Zobraz modal
    modalOverlay.style.display = 'flex';
    
    // Inicializuj mapu v modali
    const modalMap = L.map("modal-map").setView([lat, lng], 12);
    
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(modalMap);
    
    // Ak máme GPX, spracuj ho pre modálnu mapu
    if (gpxPath && window.L.GPX) {
      new L.GPX(gpxPath, {
        async: true,
        polyline_options: {
          color: '#3388ff',
          weight: 3,
          opacity: 0.8
        }
      }).on('loaded', function(e) {
        modalMap.fitBounds(e.target.getBounds());
      }).addTo(modalMap);
    }
    
    // Zavri modal po kliknutí na krížik
    closeButton.onclick = function() {
      modalOverlay.style.display = 'none';
      modalMap.remove(); // Odstráň mapu aby sa uvoľnila pamäť
    };
    
    // Zavri modal po kliknutí mimo mapu
    modalOverlay.onclick = function(e) {
      if (e.target === modalOverlay) {
        modalOverlay.style.display = 'none';
        modalMap.remove();
      }
    };
    
    // Vyvolaj resize event pre Leaflet mapu, aby sa správne prispôsobila
    setTimeout(function() {
      modalMap.invalidateSize();
    }, 10);
  }
  
  // Inicializuj event listenery pre modal
  document.getElementById('closeMapModal').addEventListener('click', function() {
    document.getElementById('mapModal').style.display = 'none';
  });
  
  // Zavri po kliknutí mimo
  window.addEventListener('click', function(e) {
    const modal = document.getElementById('mapModal');
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });

  // Zavri modal po stlačení klávesy Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modal = document.getElementById('mapModal');
    if (modal.style.display === 'flex') {
      modal.style.display = 'none';
      
      // Ak modal obsahuje inicializovanú mapu, odstráň ju pre uvoľnenie pamäte
      const modalMapElement = document.getElementById('modal-map');
      if (modalMapElement._leaflet_id) {
        const modalMap = L.DomUtil.get('modal-map')._leaflet;
        if (modalMap) {
          modalMap.remove();
        }
      }
    }
  }
});
// Zavri modal po stlačení Enter alebo Space na close button
document.getElementById('closeMapModal').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    document.getElementById('mapModal').style.display = 'none';
  }
});

const headingEls = Array.from(document.querySelectorAll('article h2[id]'));
const visibility = new Map(); // id => boolean
let lastActiveId = null;


function applyClasses() {
  const visibleIds = headingEls.filter(h => visibility.get(h.id)).map(h => h.id);
  if (visibleIds.length) {
    // add active to visible, remove from others
    headingEls.forEach(h => {
      const link = document.querySelector(`.markdown-heading a[href="#${h.id}"]`);
      if (!link) return;
      if (visibility.get(h.id)) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
    // Last active - posledný vo vizuálnom (dokumentovom) poradí spomedzi viditeľných
    lastActiveId = visibleIds[visibleIds.length - 1];
  } else if (lastActiveId) {
    // Žiadny aktuálne nevidno - nechaj svietiť len lastActiveId
    headingEls.forEach(h => {
      const link = document.querySelector(`.markdown-heading a[href="#${h.id}"]`);
      if (!link) return;
      if (h.id === lastActiveId) link.classList.add('active'); else link.classList.remove('active');
    })
  }
}

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      visibility.set(entry.target.id, entry.isIntersecting);
      if (entry.isIntersecting) {
        if (entry.isIntersecting) {
          // Update candidate immediately (v poradí dokumentu sa upraví applyClasses)
          lastActiveId = entry.target.id;
        } 
      }
    });
    applyClasses();
  }, {
    rootMargin: "0px",
    threshold: 1 // Fully visible
  });
   
  headingEls.forEach(h => {visibility.set(h.id, false);observer.observe(h);});
</script>