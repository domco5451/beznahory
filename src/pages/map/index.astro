---
import { getCollection } from 'astro:content';
import MapLayout from "../../layouts/MapLayout.astro";

const allPosts = await getCollection('blog');

// Priprav dáta pre JavaScript - extrahuj len potrebné údaje z frontmatteru
const postsData = allPosts
  .filter((post) => post.data?.latitude && post.data?.longitude)
  .map((post) => {
    // Vytvor správnu cestu k obrázku
    // Post slug obsahuje adresár, napr. "bosmany", thumbnail je "./thumbnail-blog.avif"
    const thumbnailPath = post.data.thumbnail?.src || "";
    
    return {
      title: post.data.title,
      description: post.data.description,
      thumbnailPath: thumbnailPath, // Použijeme vygenerovanú cestu od Astra
      thumbnailAlt: post.data.thumbnailAlt || "Obrázok túry",
      latitude: post.data.latitude,
      longitude: post.data.longitude,
      url: `/blog/${post.slug}`,
      slug: post.slug
    };
  });
---
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<MapLayout title="Turistická mapa">
  <div class="map-container">
    <div id="map"></div>
  </div>
</MapLayout>

<style is:inline>
  body {
    overflow: hidden;
  }
  .leaflet-popup-content-wrapper {
    padding: 0;
  }
  .leaflet-container a.leaflet-popup-close-button {
    display: none
  }
  .leaflet-popup-content-wrapper a:hover {
        background-color: rgb(131, 131, 131);
  }
  .leaflet-popup-content-wrapper a {
    color: white;
    padding: 5px;
    background: rgb(0, 0, 0);
  }
  .leaflet-popup-content {
    margin: 0;
    padding: 0;
    max-width: 300px;
    line-height: 1.5;
  }
  .map-container {
    display: flex;
    height: calc(100vh - 65px);
  }
  #map {
    width: 100%;
    height: 100%;
  }
</style>

<script define:vars={{ postsData }}>
  // Zabráň duplicitnému načítaniu Leaflet
  if (window.L) {
    initializeMap();
  } else {
    document.addEventListener("DOMContentLoaded", function () {
      const script = document.createElement("script");
      script.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
      
      script.onerror = function () {
        console.error("Nepodarilo sa načítať Leaflet JS");
        document.getElementById("map").innerHTML =
          '<p style="text-align:center;padding:20px;">Chyba pri načítavaní mapy</p>';
      };
      
      script.onload = function () {
        initializeMap();
      };
      
      document.head.appendChild(script);
    });
  }

  function initializeMap() {
    const mapElement = document.getElementById("map");
    if (!mapElement) return;

    // Vytvor mapu - default pozícia na Slovensko
    let centerLat = 48.7;
    let centerLng = 19.5;
    let zoom = 7;

    if (postsData.length > 0) {
      centerLat = postsData[0].latitude;
      centerLng = postsData[0].longitude;
      zoom = 10;
    }

    const map = L.map("map", {
      minZoom: 6,  // Zabráni prílišnému odzoomovaniu
      maxBounds: [
        [44.0, 14.0],  // Juhozápadný bod - dostatočne ďaleko aby sa nezobrazovali prázdne miesta
        [52.0, 25.0]   // Severovýchodný bod
      ],
      maxBoundsViscosity: 1.0  // Sila "pružiny" pri dosiahnutí hraníc (1.0 = úplne pevné)
    }).setView([centerLat, centerLng], zoom);

    // Pridaj dlaždice OpenStreetMap
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Pridaj markery pre každý post
    const markers = [];
    
    postsData.forEach((post) => {
      // Vytvor marker pre post
      const marker = L.marker([post.latitude, post.longitude], {
        title: post.title
      }).addTo(map);

      // Ulož POSLEDNÝ SEGMENT slugu pre neskoršie použitie
      marker.postSlug = post.slug.split('/').pop();
      markers.push(marker);

      const popupContent = `
        <div style="height: auto; min-width: 200px; max-width: 300px;">
          ${post.thumbnailPath ? `
          <div>
            <img src="${post.thumbnailPath}" alt="${post.thumbnailAlt}" style="
              border-radius: 12px 12px 0 0;
              width: 100%;
              height: 150px;
              object-fit: cover;
            "/>
          </div>` : ''}
          <div style="padding: 15px;">
            <h2 style="font-weight: bold; margin-bottom: 10px;">${post.title}</h2>
            <p style="
              text-align: justify;
              overflow: hidden; 
              display: -webkit-box; 
              -webkit-line-clamp: 3; 
              -webkit-box-orient: vertical;
              margin-bottom: 10px;
            ">${post.description}</p>
            <a href="${post.url}">Čítať blog &#8594;</a>
          </div>
        </div>
      `;
      
      marker.bindPopup(popupContent);
    });

    // Skontroluj hash v URL a vycentruj mapu na príslušný marker
    const hash = window.location.hash.replace('#', '');
    if (hash) {
      // Porovnávaj s posledným segmentom cesty
      const targetPost = postsData.find(p => p.slug.split('/').pop() === hash);
      const targetMarker = markers.find(m => m.postSlug === hash);
      
      if (targetPost && targetMarker) {
        // Vycentruj a otvor popup
        map.setView([targetPost.latitude, targetPost.longitude], 13);
        targetMarker.openPopup();
      } else {
        console.warn(`Marker pre slug "${hash}" nebol nájdený`);
      }
    } else if (markers.length > 1) {
      // Prispôsob zoom aby boli všetky markery viditeľné
      const group = new L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.1));
  }
}
</script>